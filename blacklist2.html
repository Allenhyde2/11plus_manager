<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블랙리스트 관리</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Firebase 초기화 ---
        const firebaseConfig = JSON.parse(__firebase_config);
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- 아이콘 컴포넌트 ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const ArrowLeft = () => <Icon><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></Icon>;
        const UserX = () => <Icon><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="8.5" cy="7" r="4" /><line x1="18" y1="8" x2="23" y2="13" /><line x1="23" y1="8" x2="18" y2="13" /></Icon>;
        const Clipboard = () => <Icon><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /></Icon>;
        const CheckCircle = () => <Icon><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></Icon>;
        const AlertOctagon = () => <Icon><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></Icon>;
        const DownloadIcon = () => <Icon><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></Icon>;
        const Paperclip = () => <Icon><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" /></Icon>;

        // --- 메인 컴포넌트 ---
        const BlacklistManager = () => {
            const [user, setUser] = useState(null);
            const [step, setStep] = useState(1);
            const [list, setList] = useState([]);
            const [loading, setLoading] = useState(false);

            // 입력 폼 상태
            const [formData, setFormData] = useState({
                nickname: '',
                userId: '',
                email: '',
                joinDate: '',
                joinMethod: '',
                joinStatus: '',
                language: '',
                reasonText: '',
                files: [] // { name: string, data: base64 } 배열
            });

            const [pasteText, setPasteText] = useState('');

            // Firebase 인증
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();
                return auth.onAuthStateChanged(setUser);
            }, []);

            // 데이터 로드 (Firestore)
            useEffect(() => {
                if (!user) return;
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('blacklist');
                
                return collectionRef.onSnapshot((snapshot) => {
                    const items = [];
                    snapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    // 최신 등록순 정렬
                    items.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setList(items);
                });
            }, [user]);

            // 스마트 붙여넣기 로직 (닉네임 첫줄 + 불필요 항목 제거)
            const handleSmartPaste = () => {
                if (!pasteText.trim()) return;

                let parsedData = { ...formData };
                let textToParse = pasteText.trim();

                // 1. 줄 단위로 분리하여 첫 줄(닉네임) 처리
                const lines = textToParse.split(/\r\n|\n|\r/);
                
                if (lines.length > 0) {
                    const firstLine = lines[0].trim();
                    // 첫 줄이 '사용자 ID'로 시작하지 않으면 닉네임으로 간주
                    if (firstLine && !firstLine.startsWith("사용자 ID")) {
                        parsedData.nickname = firstLine;
                        // 첫 줄 제외하고 나머지는 한 줄로 합쳐서 키워드 파싱 준비
                        textToParse = lines.slice(1).join(''); 
                    } else {
                        textToParse = lines.join('');
                    }
                }

                // 2. 정밀 파싱을 위한 전체 키워드 정의
                // field가 null인 것은 데이터를 추출하지 않고 건너뛰기 위한 구분자
                const keys = [
                    { key: "사용자 ID", field: "userId" },
                    { key: "최근 활동 일시", field: null }, 
                    { key: "앱 첫 로그인", field: null },
                    { key: "휴대폰 번호", field: null },
                    { key: "이메일", field: "email" },
                    { key: "지갑 주소", field: null },
                    { key: "가입 일시", field: "joinDate" },
                    { key: "가입 방법", field: "joinMethod" },
                    { key: "가입 상태(초대자)", field: "joinStatus" }, 
                    { key: "레벨", field: null },
                    { key: "최초 접속 언어", field: null },
                    { key: "설정 언어", field: "language" }
                ];

                // 3. 키워드 기반 값 추출
                for (let i = 0; i < keys.length; i++) {
                    const curr = keys[i];
                    const next = keys[i+1];
                    
                    const startIdx = textToParse.indexOf(curr.key);
                    if (startIdx === -1) continue;

                    const valStart = startIdx + curr.key.length;
                    let val = "";

                    if (next) {
                        const endIdx = textToParse.indexOf(next.key);
                        // 다음 키워드가 존재하고, 현재 키워드 뒤에 있다면 그 사이 문자열 추출
                        if (endIdx !== -1 && endIdx > valStart) {
                            val = textToParse.substring(valStart, endIdx);
                        } else {
                            // 다음 키워드를 못 찾았으면 끝까지
                            val = textToParse.substring(valStart);
                        }
                    } else {
                        // 마지막 키워드인 경우
                        val = textToParse.substring(valStart);
                    }

                    // field가 있는 경우만 저장 (불필요 항목 제거됨)
                    if (curr.field) {
                        parsedData[curr.field] = val.trim();
                    }
                }

                // 안전장치: 닉네임이 텍스트에 없었지만 사용자 ID가 있다면 임시 생성
                if (!parsedData.nickname && parsedData.userId) {
                    parsedData.nickname = "User_" + parsedData.userId.substring(0, 5);
                }

                setFormData(parsedData);
                alert("회원 정보가 자동으로 입력되었습니다.");
                setPasteText(""); 
            };

            const handleNextStep = () => {
                if (!formData.userId) return alert("사용자 ID는 필수입니다.");
                setStep(2);
            };

            const handleSubmit = async () => {
                if (!formData.reasonText) return alert("블랙리스트 등록 사유를 입력해주세요.");
                if (!user) return;

                setLoading(true);
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('blacklist').add({
                        ...formData,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        registrar: user.uid
                    });
                    
                    alert("블랙리스트에 등록되었습니다.");
                    // 초기화
                    setFormData({
                        nickname: '', userId: '', email: '', joinDate: '', joinMethod: '', 
                        joinStatus: '', language: '', reasonText: '', files: []
                    });
                    setStep(1);
                } catch (e) {
                    console.error(e);
                    alert("등록 중 오류가 발생했습니다 (파일 크기 제한 등).");
                } finally {
                    setLoading(false);
                }
            };

            // 다중 파일 처리 로직
            const handleFileChange = async (e) => {
                if (e.target.files) {
                    const fileList = Array.from(e.target.files);
                    const readPromises = fileList.map(file => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                resolve({
                                    name: file.name,
                                    data: reader.result // Base64 Data
                                });
                            };
                            reader.readAsDataURL(file);
                        });
                    });
                    const fileObjects = await Promise.all(readPromises);
                    // 기존 파일에 추가하는 방식이 아니라 교체하는 방식 (필요시 [...prev, ...new] 로 변경 가능)
                    setFormData({ ...formData, files: fileObjects });
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 p-6 font-sans text-gray-800">
                    <div className="max-w-6xl mx-auto">
                        
                        {/* 헤더 */}
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-4">
                                <a href="./index.html" className="p-2 bg-white rounded-full shadow-sm hover:bg-gray-50 transition text-gray-600">
                                    <ArrowLeft />
                                </a>
                                <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <UserX className="text-red-600" />
                                    블랙리스트 관리
                                </h1>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* 왼쪽: 입력 폼 */}
                            <div className="lg:col-span-1 space-y-6">
                                {/* Step 1: 회원 정보 */}
                                <div className={`bg-white p-6 rounded-xl shadow-sm border ${step === 1 ? 'border-blue-500 ring-2 ring-blue-100' : 'border-gray-200'}`}>
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-lg font-bold text-gray-700">1. 회원 정보</h2>
                                        {step > 1 && <button onClick={() => setStep(1)} className="text-xs text-blue-600 hover:underline">수정하기</button>}
                                    </div>
                                    <div className="space-y-3 text-sm">
                                        {/* 1순위: 닉네임 */}
                                        <div>
                                            <label className="block text-gray-500 mb-1">닉네임 <span className="text-red-500">*</span></label>
                                            <input type="text" className="w-full p-2 border rounded bg-gray-50 font-bold text-gray-800" value={formData.nickname} onChange={(e) => setFormData({...formData, nickname: e.target.value})} placeholder="닉네임" disabled={step !== 1}/>
                                        </div>
                                        {/* 2순위: 사용자 ID */}
                                        <div>
                                            <label className="block text-gray-500 mb-1">사용자 ID <span className="text-red-500">*</span></label>
                                            <input type="text" className="w-full p-2 border rounded bg-gray-50" value={formData.userId} onChange={(e) => setFormData({...formData, userId: e.target.value})} placeholder="U0P..." disabled={step !== 1}/>
                                        </div>
                                        <div>
                                            <label className="block text-gray-500 mb-1">이메일</label>
                                            <input type="text" className="w-full p-2 border rounded bg-gray-50" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} disabled={step !== 1}/>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-2">
                                            <div><label className="block text-gray-500 mb-1">설정 언어</label><input type="text" className="w-full p-2 border rounded bg-gray-50" value={formData.language} onChange={(e) => setFormData({...formData, language: e.target.value})} disabled={step !== 1}/></div>
                                            <div><label className="block text-gray-500 mb-1">가입 일시</label><input type="text" className="w-full p-2 border rounded bg-gray-50" value={formData.joinDate} onChange={(e) => setFormData({...formData, joinDate: e.target.value})} disabled={step !== 1}/></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div><label className="block text-gray-500 mb-1">가입 방법</label><input type="text" className="w-full p-2 border rounded bg-gray-50" value={formData.joinMethod} onChange={(e) => setFormData({...formData, joinMethod: e.target.value})} disabled={step !== 1}/></div>
                                            <div><label className="block text-gray-500 mb-1">가입 상태</label><input type="text" className="w-full p-2 border rounded bg-gray-50" value={formData.joinStatus} onChange={(e) => setFormData({...formData, joinStatus: e.target.value})} disabled={step !== 1}/></div>
                                        </div>
                                    </div>
                                </div>

                                {/* 스마트 붙여넣기 (Step 1) */}
                                {step === 1 && (
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                        <h3 className="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2"><Clipboard className="w-4 h-4" />회원 정보 복사해넣기</h3>
                                        <div className="text-xs text-blue-600 mb-2">* 1번 줄: 닉네임 / 이후: 상세 정보 (필요 정보만 추출)</div>
                                        <textarea className="w-full p-2 text-xs border border-blue-200 rounded bg-white h-24 resize-none focus:outline-none focus:border-blue-400" placeholder="관리자 페이지의 텍스트를 그대로 붙여넣으세요." value={pasteText} onChange={(e) => setPasteText(e.target.value)}></textarea>
                                        <button onClick={handleSmartPaste} className="w-full mt-2 py-1.5 bg-blue-200 text-blue-800 rounded text-xs font-bold hover:bg-blue-300 transition">정보 자동 채우기</button>
                                    </div>
                                )}

                                {/* 확인 버튼 (Step 1) */}
                                {step === 1 && (
                                    <button onClick={handleNextStep} className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold shadow-md">확인 및 다음 단계</button>
                                )}

                                {/* Step 2: 사유 및 파일 */}
                                {step === 2 && (
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-red-200 ring-2 ring-red-50 animate-fade-in">
                                        <h2 className="text-lg font-bold text-red-700 mb-4">2. 블랙리스트 등록 사유</h2>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-gray-500 mb-1 text-sm">등록 사유 *</label>
                                                <textarea className="w-full p-3 border rounded bg-gray-50 h-32 resize-none focus:bg-white transition" placeholder="구체적인 사유 입력" value={formData.reasonText} onChange={(e) => setFormData({...formData, reasonText: e.target.value})}></textarea>
                                            </div>
                                            <div>
                                                <label className="block text-gray-500 mb-1 text-sm">증빙 파일 첨부 (다중 선택 가능)</label>
                                                <input type="file" multiple className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100" onChange={handleFileChange}/>
                                                {formData.files.length > 0 && (
                                                    <div className="mt-2 text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-200">
                                                        <p className="font-bold mb-1">첨부 대기중 ({formData.files.length}개):</p>
                                                        <ul className="list-disc list-inside space-y-0.5">
                                                            {formData.files.map((f, i) => (
                                                                <li key={i} className="truncate">{f.name}</li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}
                                            </div>
                                            <button onClick={handleSubmit} disabled={loading} className="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold shadow-md flex justify-center items-center gap-2">{loading ? "처리 중..." : "블랙리스트 등록 완료"}{!loading && <CheckCircle className="w-4 h-4" />}</button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* 오른쪽: 리스트 뷰 */}
                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                                        <h3 className="font-bold text-gray-700 flex items-center gap-2"><AlertOctagon className="text-red-500 w-5 h-5" />등록된 블랙리스트 ({list.length}명)</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-100 text-gray-600 font-medium">
                                                <tr>
                                                    <th className="px-4 py-3 w-24">등록일시</th>
                                                    <th className="px-4 py-3 w-32">닉네임</th>
                                                    <th className="px-4 py-3 w-32">사용자 ID</th>
                                                    <th className="px-4 py-3 w-48">이메일</th>
                                                    <th className="px-4 py-3">사유</th>
                                                    <th className="px-4 py-3 w-24">증빙파일</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {list.length === 0 ? (
                                                    <tr><td colSpan="6" className="text-center py-10 text-gray-400">등록된 블랙리스트가 없습니다.</td></tr>
                                                ) : (
                                                    list.map((item) => (
                                                        <tr key={item.id} className="hover:bg-gray-50">
                                                            <td className="px-4 py-3 text-gray-500 whitespace-nowrap">{item.timestamp?.seconds ? new Date(item.timestamp.seconds * 1000).toLocaleDateString() : '-'}</td>
                                                            <td className="px-4 py-3 font-bold text-gray-800">{item.nickname || '-'}</td>
                                                            <td className="px-4 py-3 font-mono text-gray-600 text-xs">{item.userId}</td>
                                                            <td className="px-4 py-3 text-gray-600 truncate max-w-[150px]" title={item.email}>{item.email || '-'}</td>
                                                            <td className="px-4 py-3 text-red-600 font-medium truncate max-w-[200px]" title={item.reasonText}>{item.reasonText}</td>
                                                            <td className="px-4 py-3 text-gray-500">
                                                                {item.files && item.files.length > 0 ? (
                                                                    <div className="flex flex-col gap-1">
                                                                        {item.files.map((f, i) => (
                                                                            <a key={i} href={f.data} download={f.name} className="flex items-center gap-1 text-blue-600 hover:underline hover:text-blue-800 transition">
                                                                                <DownloadIcon className="w-3 h-3" />
                                                                                <span className="text-xs max-w-[100px] truncate">{f.name}</span>
                                                                            </a>
                                                                        ))}
                                                                    </div>
                                                                ) : '-'}
                                                            </td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BlacklistManager />);
    </script>
</body>
</html>
